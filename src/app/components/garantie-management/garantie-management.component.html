

<div class="garantie-container">
  <h2>Gestion des Garanties et Clausiers</h2>

  <!-- ================= Slider de navigation ================= -->
  <div class="slider-nav">
    <button
      [class.active]="activeTab === 'garanties'"
      (click)="activeTab = 'garanties'">
      Garanties
    </button>

    <button
      [class.active]="activeTab === 'clausiers'"
      (click)="activeTab = 'clausiers'">
      Clausiers
    </button>

    <button
      [class.active]="activeTab === 'exclusions'"
      (click)="openExclusionDialog()">
      Exclusions globales
    </button>
  </div>

  <!-- ================= Section Garanties ================= -->
  <div *ngIf="activeTab === 'garanties'" class="tab-content">

    <div class="add-garantie">
      <input
        type="text"
        placeholder="Nouvelle garantie..."
        [(ngModel)]="newGarantieLibelle" />
      <button (click)="addGarantie()">
        <i class="pi pi-plus"></i> Ajouter
      </button>
    </div>

    <div *ngIf="garanties.length === 0" class="empty">
      Aucune garantie disponible.
    </div>

    <div *ngIf="garanties.length > 0" class="garantie-list">
      <div
        *ngFor="let g of garanties"
        class="garantie-card"
        (click)="openBrancheDialog(g.id)">
        <div class="garantie-item">
          <span>{{ g.libelle }}</span>
          <i
            class="pi pi-trash delete-icon"
            (click)="confirmDelete(g.id, g.libelle); $event.stopPropagation()">
          </i>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= Section Clausiers ================= -->
  <div *ngIf="activeTab === 'clausiers'" class="tab-content">

    <div class="add-garantie">
      <input
        type="text"
        placeholder="Nom du clausier..."
        [(ngModel)]="newClausierLibelle" />

      <input
        type="file"
        #fileInput
        accept=".pdf"
        (change)="onFileSelected($event)"
        hidden />

      <button (click)="fileInput.click()">
        <i class="pi pi-upload"></i> Choisir PDF
      </button>
    </div>

    <div *ngIf="clausiers.length === 0" class="empty">
      Aucun clausier disponible.
    </div>

    <div *ngIf="clausiers.length > 0" class="clausier-grid">
      <div *ngFor="let c of clausiers" class="clausier-card">
        <div class="clausier-header">
          <h4>{{ c.nom }}</h4>
          <i
            class="pi pi-trash delete-icon"
            (click)="confirmDeleteClausier(c.id, c.nom)">
          </i>
        </div>

        <div class="files-section">
          <div *ngIf="c.file; else noFile" class="file-item">
            <i class="pi pi-file-pdf"></i>
            <span>{{ c.nom }}</span>
            <i class="pi pi-download" (click)="downloadPdf(c)"></i>
          </div>

          <ng-template #noFile>
            <div class="no-files">Aucun fichier PDF</div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

 <!-- ================= Section Exclusions Globales ================= -->
<div *ngIf="activeTab === 'exclusions'" class="tab-content">

  <h3>Exclusions globales</h3>

  <!-- Ajout exclusion globale -->
  <div class="add-exclusion">
    <input
      type="text"
      placeholder="Nouvelle exclusion globale..."
      [(ngModel)]="newExclusionLibelle" />

    <button (click)="addExclusionGlobal()">
      <i class="pi pi-plus"></i> Ajouter
    </button>
  </div>

  <!-- Message si aucune exclusion -->
  <div *ngIf="exclusionsGlobales.length === 0" class="empty">
    Aucune exclusion globale pour cette branche.
  </div>

  <!-- ✅ Card unique contenant toutes les exclusions -->
  <div *ngIf="exclusionsGlobales.length > 0" class="exclusion-card">
    <h4>Liste des exclusions</h4>

    <div class="exclusion-list">
      <div *ngFor="let e of exclusionsGlobales" class="exclusion-item">
        <span>{{ e.libelle }}</span>

        <i
          class="pi pi-trash delete-icon"
          (click)="confirmDeleteExclusion(e.id)"
          title="Supprimer">
        </i>
      </div>
    </div>
  </div>
</div>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>

<!-- ================= Modale Branche – Garanties ================= -->
<div *ngIf="displayBrancheDialog" class="popup-overlay">
  <div class="p-dialog popup-content">
    <h3>Sélectionner la branche</h3>

    <select [(ngModel)]="selectedBranche">
      <option *ngFor="let b of Branche" [ngValue]="b.value">
        {{ b.label }}
      </option>
    </select>

    <div class="popup-actions">
      <button (click)="onBrancheSelected()">Valider</button>
      <button (click)="displayBrancheDialog = false">Annuler</button>
    </div>
  </div>
</div>

<!-- ================= Modale Branche – Exclusions ================= -->
<div *ngIf="displayExclusionDialog" class="popup-overlay">
  <div class="p-dialog popup-content">
    <h3>Sélectionner la branche</h3>

    <select [(ngModel)]="selectedExclusionBranche">
      <option [ngValue]="null">-- Sélectionner --</option>
      <option *ngFor="let b of Branche" [ngValue]="b.value">
        {{ b.label }}
      </option>
    </select>

    <div class="popup-actions">
      <button (click)="confirmExclusionBranche()">Valider</button>
      <button (click)="displayExclusionDialog = false">Annuler</button>
    </div>
  </div>
</div>
