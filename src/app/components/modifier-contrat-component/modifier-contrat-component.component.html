
    <div class="contrat-main-container" [class.split-view]="showModele"> 

<div class="contrat-container">
  <p-toast></p-toast>

  <p-steps [model]="steps" [(activeIndex)]="currentStep"></p-steps>
<div style="display: flex; justify-content: flex-end; margin: 1rem 0;">
      <button 
        pButton 
        label="{{ showModele ? 'Fermer le mod√®le' : 'Voir le mod√®le' }}" 
        icon="{{ showModele ? 'pi pi-eye-slash' : 'pi pi-eye' }}"
        (click)="toggleModele()" 
        class="p-button-info"
      >
      </button>
    </div>
  <!-- √âtape 0 -->
  <div *ngIf="currentStep === 0" class="contrat-section">
    <h3>Informations g√©n√©rales</h3>

    <h4>Adh√©rent</h4>
    <label>Code Adh√©rent:</label>
    <input type="text" [(ngModel)]="adherent.codeId">
    <label>Nom / Raison sociale:</label>
    <input type="text" [(ngModel)]="adherent.nomRaison">
    <label>Adresse:</label>
    <input type="text" [(ngModel)]="adherent.adresse">
    <label>Profession:</label>
    <input type="text" [(ngModel)]="adherent.activite">
    <div class="custom-checkbox-label" style="margin-bottom: 1rem;">
      <p-checkbox [(ngModel)]="adherent.nouveau" binary="true" class="custom-checkbox"></p-checkbox>
      <span>Nouvel adh√©rent ?</span>
    </div>

    <label>Branche:</label>
    <select [(ngModel)]="branche" (ngModelChange)="onBrancheChange()">
      <option *ngFor="let opt of brancheOptions" [value]="opt.value">{{ opt.label }}</option>
    </select>
    <label>Code Produit:</label>
  <input type="number" [(ngModel)]="service" placeholder="Entrez le code produit" />

    <label>Num√©ro de police:</label>
    <input type="text" [(ngModel)]="numPolice">
    <label>Activit√© professionnelle de l'Assur√©:</label>
    <input type="text" [(ngModel)]="nom_assure">
    <label>Code Agence:</label>
    <input type="text" [(ngModel)]="codeAgence">

    <label>Fractionnement:</label>
    <select [(ngModel)]="fractionnement">
      <option *ngFor="let opt of fractionnementOptions" [value]="opt.value">{{ opt.label }}</option>
    </select>

    <label>Code Renouvellement:</label>
    <select [(ngModel)]="codeRenouvellement">
      <option *ngFor="let opt of codeRenouvellementOptions" [value]="opt.value">{{ opt.label }}</option>
    </select>

    <label>Type de contrat:</label>
    <select [(ngModel)]="typeContrat">
      <option *ngFor="let opt of typeContratOptions" [value]="opt.value">{{ opt.label }}</option>
    </select>

    <label>Date d√©but:</label>
    <input type="date" [(ngModel)]="dateDebut">
    <label>Date fin:</label>
    <input type="date" [(ngModel)]="dateFin">

    <div style="margin-top: 10px; display: flex; gap: 1rem;">
      <button pButton label="Suivant ‚Üí" (click)="currentStep=1"></button>
      <button pButton label="Annuler" class="p-button-danger" (click)="cancel()"></button>
    </div>
  </div>


<!-- === Step Pr√©ambule === -->
<div *ngIf="currentStep === 1" class="contrat-section preambule-section">
  <h3>Pr√©ambule du contrat</h3>
  <textarea id="preambuleTextarea"
            class="p-inputtextarea p-component"
            rows="10"
            [(ngModel)]="preambule"
            [attr.maxlength]="preambuleMaxLength"
            style="width:100%; resize:vertical;"></textarea>

    <div class="navigation">
      <button pButton label="‚Üê Pr√©c√©dent" (click)="currentStep=0"></button>
      <button pButton label="Suivant ‚Üí" (click)="currentStep=2"></button>
      <button pButton label="Annuler" class="p-button-danger" (click)="cancel()"></button>
    </div>
</div>



  <!-- √âtape 1 : Situations -->
  <div *ngIf="currentStep === 2" class="contrat-section">
    <h3>Situations de risque</h3>
    <div *ngFor="let s of situationRisques; let i = index" class="situation-card">
      <div class="situation-header">
        <h4>Situation {{i+1}} : {{s.identification}}</h4>
        <i class="pi pi-trash delete-icon" (click)="removeSituation(i)" title="Supprimer"></i>
      </div>

      <label>Identification:</label>
      <input type="text" [(ngModel)]="s.identification">
      <label>Adresse:</label>
      <input type="text" [(ngModel)]="s.adresse">
      <label>Nature construction:</label>
      <input type="text" [(ngModel)]="s.natureConstruction">
      <label>Contigu√Øt√©:</label>
      <input type="text" [(ngModel)]="s.contiguite">
      <label>Avoisinage:</label>
      <input type="text" [(ngModel)]="s.avoisinage">
    </div>

    <button pButton label="Ajouter situation" (click)="addSituation()" class="add-btn"></button>

  <div class="navigation">
      <button pButton label="‚Üê Pr√©c√©dent" (click)="currentStep=0"></button>
      <button pButton label="Suivant ‚Üí" (click)="currentStep=3"></button>
      <button pButton label="Annuler" class="p-button-danger" (click)="cancel()"></button>
    </div>
  </div>
<!-- √âtape 3 : Garanties -->
<div *ngIf="currentStep === 3" class="contrat-section">
  <h3>Garanties</h3>
  <div *ngFor="let s of situationRisques; let i=index" class="situation-card">
    <h4>Situation {{i+1}} : {{s.identification}}</h4>
    <div *ngFor="let g of s.garanties; let j=index" class="garantie-card">
      <div class="garantie-header">
        <label>Garantie: {{getGarantieName(g.sousGarantieId)}}</label>
        <i class="pi pi-trash delete-icon" (click)="removeGarantie(s,j)" title="Supprimer"></i>
      </div>

      <!-- üî• CORRECTION: Changer loadExclusionsForGarantie(g) par onGarantieChange(g) -->
      <select [(ngModel)]="g.sousGarantieId" (change)="onGarantieChange(g)">
        <option [value]="0">S√©lectionner</option>
        <option *ngFor="let sg of sousGarantiesOptions" [value]="sg.value">{{sg.label}}</option>
      </select>

      <label>Capitale Assur√©</label>
      <input type="number" [(ngModel)]="g.capitale">
      
      <!-- Checkbox Franchise avec affichage conditionnel -->
      <div class="checkbox-container">
        <label>
          <p-checkbox 
            [(ngModel)]="g.hasFranchise" 
            [binary]="true" 
            inputId="franchise{{i}}{{j}}"
            label="Franchise">
          </p-checkbox>
          Franchise
        </label>
      </div>

      <!-- Champs franchise/minimum/maximum conditionnels -->
      <div *ngIf="g.hasFranchise" class="franchise-fields">
        <label>Franchise (%)</label>
        <input type="number" [(ngModel)]="g.franchise" min="0">
        
        <label>Minimum</label>
        <input type="number" [(ngModel)]="g.minimum" min="0">
        
        <label>Maximum</label>
        <input type="number" [(ngModel)]="g.maximum" min="0">
      </div>

      <label>Prime NET</label>
      <input type="number" [(ngModel)]="g.primeNET">

    </div>

    <button pButton label="Ajouter garantie" (click)="addGarantie(s)" class="add-btn"></button>
  </div>

  <div style="margin-top:10px; display:flex; justify-content: space-between;">
    <button pButton label="‚Üê Pr√©c√©dent" (click)="currentStep=2"></button>
    <button pButton label="Suivant ‚Üí" (click)="currentStep=4"></button>
    <button pButton label="Annuler" class="p-button-danger" (click)="cancel()"></button>
  </div>
</div>
<div *ngIf="currentStep === 4" class="contrat-section">
  <h3>Exclusions par garantie</h3>
  
  <!-- Indicateur de chargement global -->
  <div *ngIf="isLoadingExclusions" class="loading-indicator">
    <p>Chargement des exclusions en cours...</p>
  </div>

  <div *ngFor="let s of situationRisques; let i = index" class="situation-container">
    <h4>Situation {{ i + 1 }} : {{ s.identification }}</h4>

    <!-- V√©rification si des groupes existent -->
    <div *ngIf="getGarantiesGroupedByParent(s).length > 0; else noGaranties">
      
      <!-- Parcourir les groupes de sous-garanties par garantie parent -->
      <div *ngFor="let groupe of getGarantiesGroupedByParent(s); let groupeIndex = index" 
           class="groupe-garantie" style="margin-bottom: 2rem; padding: 1rem; border: 1px solid #e0e0e0; border-radius: 5px;">
        
        <h5 style="color: #499946; margin-bottom: 1rem;">Garantie : {{ groupe.parentLibelle || 'Garantie sans nom' }}</h5>

        <!-- üî• AJOUT: Indicateur de chargement pour ce groupe -->
        <div *ngIf="!groupe.garanties[0]?.exclusionsOptions && groupe.garanties[0]?.sousGarantieId" 
             class="loading-exclusions" style="color: #007ad9; font-style: italic;">
          Chargement des exclusions pour {{ groupe.parentLibelle }}...
        </div>

        <!-- Section pour ajouter une nouvelle exclusion -->
        <div class="ajout-exclusion" 
             *ngIf="groupe.garanties && groupe.garanties.length > 0 && groupe.garanties[0] && groupe.garanties[0].exclusionsOptions"
             style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
          
          <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">
            Ajouter une nouvelle exclusion pour cette garantie :
          </label>
          
          <div style="display: flex; gap: 0.5rem;">
            <input 
              type="text" 
              [(ngModel)]="groupe.garanties[0].nouvelleExclusion"
              placeholder="Saisir le nom de la nouvelle exclusion..."
              style="flex: 1; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;"
              (keyup.enter)="ajouterExclusionPersonnalisee(groupe.garanties[0])">
            
            <button 
              pButton 
              label="Ajouter" 
              icon="pi pi-plus"
              (click)="ajouterExclusionPersonnalisee(groupe.garanties[0])"
              class="p-button-sm"
              style="height: 38px; min-width: 100px;"
              [disabled]="!groupe.garanties[0].nouvelleExclusion?.trim()">
            </button>
          </div>
        </div>

        <!-- Liste des exclusions -->
        <div *ngIf="groupe.garanties && groupe.garanties.length > 0 && groupe.garanties[0] && 
                    groupe.garanties[0].exclusionsOptions && groupe.garanties[0].exclusionsOptions.length > 0" 
             class="exclusions-container">
          
          <label class="exclusions-label" style="font-weight: bold; display: block; margin-bottom: 0.5rem;">
            S√©lectionner les exclusions applicables :
          </label>
          
          <div class="exclusions-scroll-container" tabindex="0" 
               (keydown)="handleKeyboardExclusions($event, groupe.garanties[0])"
               style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 1rem; border-radius: 4px;">
            
            <div class="exclusions-list">
              <div *ngFor="let exclusion of groupe.garanties[0].filteredExclusionsOptions; let exclIndex = index" 
                   class="exclusion-item" style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                
                <input 
                  type="checkbox" 
                  [id]="'exclusion_' + i + '_' + groupeIndex + '_' + exclIndex"
                  [checked]="isExclusionSelectedForGroup(groupe.garanties, exclusion.id)"
                  (change)="toggleExclusionForGroup(groupe.garanties, exclusion.id, $event)"
                  class="exclusion-checkbox" style="margin-right: 0.5rem;">
                
                <label 
                  [for]="'exclusion_' + i + '_' + groupeIndex + '_' + exclIndex" 
                  class="exclusion-text"
                  style="cursor: pointer; flex: 1;">
                  {{ exclusion.nom }}
                </label>
              </div>
            </div>
          </div>

          <!-- Indicateur de filtrage clavier -->
          <div *ngIf="groupe.garanties[0].keyboardFilterExclusions" 
               style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
            Filtre actif : "{{ groupe.garanties[0].keyboardFilterExclusions }}"
          </div>
        </div>

        <!-- Message si aucune exclusion disponible -->
        <div *ngIf="groupe.garanties && groupe.garanties[0] && groupe.garanties[0].exclusionsOptions && 
                    groupe.garanties[0].exclusionsOptions.length === 0">
          <p style="color: #999; font-style: italic;">Aucune exclusion disponible pour cette garantie.</p>
        </div>

        <!-- Message si aucune sous-garantie s√©lectionn√©e -->
        <div *ngIf="groupe.garanties && groupe.garanties[0] && !groupe.garanties[0].sousGarantieId">
          <p style="color: #ff9800; font-style: italic;">
            Veuillez s√©lectionner une sous-garantie dans l'√©tape "Garanties" pour voir les exclusions disponibles.
          </p>
        </div>

      </div>
    </div>

    <ng-template #noGaranties>
      <p style="color: #999; font-style: italic;">Aucune garantie disponible pour cette situation.</p>
    </ng-template>
  </div>

  <div style="margin-top: 10px; display: flex; gap: 1rem;">
    <button pButton label="‚Üê Pr√©c√©dent" (click)="currentStep = 3"></button>
    <button pButton label="Suivant ‚Üí" (click)="currentStep = 5"></button>
    <button pButton label="Annuler" class="p-button-danger" (click)="cancel()"></button>
  </div>
</div>
 <!-- √âtape 5 : RC Exploitation -->
<div *ngIf="currentStep === 5" class="contrat-section">
  <h3>RC Exploitation</h3>

  <!-- Objet de la garantie -->
  <div class="card" style="background-color: #e8f5e9; margin-bottom: 2rem;">
    <label>Objet de la garantie</label>
    <textarea 
      [value]="objetGarantieRc" 
      rows="3" 
      class="p-inputtextarea p-component"
      style="width: 100%; resize: vertical;"
      readonly
    ></textarea>
  </div>

  <!-- Liste des RC Exploitation existantes -->
  <div *ngIf="rcExploitations.length > 0" style="margin-top: 2rem;">
    <h4>RC Exploitation configur√©es :</h4>
    <div *ngFor="let rc of rcExploitations; let i = index" class="rc-item card" style="padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #388e3c;">
      <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
          <strong>RC {{ i + 1 }}</strong>
          <div style="margin-top: 0.5rem;">
            <strong>Param√®tres :</strong><br>
            ‚Ä¢ Dommages Corporels: {{ rc.limiteAnnuelleDomCorporels }}<br>
            ‚Ä¢ Dommages Mat√©riels: {{ rc.limiteAnnuelleDomMateriels }}<br>
            ‚Ä¢ Limite/sinistre: {{ rc.limiteParSinistre }}<br>
            ‚Ä¢ Franchise: {{ rc.franchise }}<br>
            ‚Ä¢ Prime NET: {{ rc.primeNET }}
          </div>
          <div style="margin-top: 0.5rem;">
            <strong>Situations couvertes :</strong><br>
            {{ getRcSituationsNames(rc) }}
          </div>
          <div style="margin-top: 0.5rem;">
            <strong>Exclusions ({{ (rc.exclusionsIds || []).length }})</strong>
          </div>
        </div>
        <div>
          <i class="pi pi-pencil" 
             style="color: #388e3c; cursor: pointer; margin-right: 10px;" 
             (click)="editRcExploitation(i)"
             title="Modifier"></i>
          <i class="pi pi-trash" 
             style="color: #e74c3c; cursor: pointer;" 
             (click)="removeRcExploitation(i)"
             title="Supprimer"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulaire pour ajouter/modifier une RC -->
  <div class="contrat-section">
    <h4>{{ rcExploitations.length > 0 ? 'Ajouter une autre RC Exploitation' : 'Configurer une RC Exploitation' }}</h4>

    <!-- Param√®tres de la RC -->
    <div class="form-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
      <div class="form-group">
        <label>Limite annuelle Dommages Corporels</label>
        <input type="number" [(ngModel)]="currentRcExploitation.limiteAnnuelleDomCorporels" class="w-full">
      </div>

      <div class="form-group">
        <label>Limite annuelle Dommages Mat√©riels</label>
        <input type="number" [(ngModel)]="currentRcExploitation.limiteAnnuelleDomMateriels" class="w-full">
      </div>

      <div class="form-group">
        <label>Limite par sinistre</label>
        <input type="number" [(ngModel)]="currentRcExploitation.limiteParSinistre" class="w-full">
      </div>

      <div class="form-group">
        <label>Franchise</label>
        <input type="number" [(ngModel)]="currentRcExploitation.franchise" class="w-full">
      </div>

      <div class="form-group">
        <label>Prime Net</label>
        <input type="number" [(ngModel)]="currentRcExploitation.primeNET" class="w-full">
      </div>
    </div>
  <div class="col-12">
  <div class="card">
    <h5>S√©lectionner les situations pour cette RC :</h5>
    <div class="grid">
      <div *ngFor="let s of situationRisques" class="col-12 md:col-6">
        <div class="field-checkbox situation-item">
          <label [class.disabled]="isSituationUsedInOtherRc(s, currentRcExploitation.id || -1)" 
                 class="checkbox-label">
            
            <!-- ‚úÖ CORRECTION: Utiliser [(ngModel)] avec une propri√©t√© d√©di√©e -->
             <p-checkbox 
              [inputId]="'situation_' + s.identification"
              [binary]="true"
              [(ngModel)]="situationSelectionStates[s.identification]"
              (onChange)="onRcSituationChange(s, $event)"
              [disabled]="isSituationUsedInOtherRc(s, currentRcExploitation.id || -1)"
              [ngModelOptions]="{standalone: true}">
            </p-checkbox>
            
            <div class="situation-info">
              <strong>{{ s.identification }}</strong>
              <div class="situation-adresse">{{ s.adresse }}</div>
              <div *ngIf="isSituationCoveredByRc(s)" class="situation-covered">
             
              </div>
            </div>
            
            <span *ngIf="isSituationUsedInOtherRc(s, currentRcExploitation.id || -1)" 
                  class="situation-used-elsewhere">
        
            </span>
          </label>
        </div>
      </div>
    </div>
  </div>
</div>
</div>    <!-- Exclusions -->
    <div class="exclusions-section" style="margin-top: 2rem;">
      <h5>Exclusions pour cette RC :</h5>

      <div class="ajout-exclusion" style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
        <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">
          Ajouter une nouvelle exclusion RC :
        </label>
        <div style="display: flex; gap: 0.5rem;">
          <input 
            type="text" 
            [(ngModel)]="nouvelleExclusionRC"
            placeholder="Saisir le nom de la nouvelle exclusion RC..."
            style="flex: 1; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;"
            (keyup.enter)="ajouterExclusionRC()">
          <button 
            pButton 
            label="Ajouter" 
            icon="pi pi-plus"
            (click)="ajouterExclusionRC()"
            class="p-button-sm"
            style="height: 38px; min-width: 100px;">
          </button>
        </div>
      </div>

      <div *ngIf="filteredExclusionsRC.length > 0" class="exclusions-container">
        <label class="exclusions-label">S√©lectionner les exclusions applicables :</label>
        <div class="card">
         <div class="exclusions-scroll-container rc-exclusions-scroll">
          <div class="exclusions-list">
            <div *ngFor="let ex of filteredExclusionsRC" 
                 class="exclusion-item" style="padding: 0.5rem; border-bottom: 1px solid #eee;">
              
              <input 
                type="checkbox" 
                [id]="'exclusionRC_' + ex.id"
                [checked]="currentRcExploitation.exclusionsIds.includes(ex.id)"
                (change)="toggleCurrentRcExclusion(ex.id, $event)"
                class="exclusion-checkbox"
                style="margin-right: 0.5rem;">
              
              <label 
                [for]="'exclusionRC_' + ex.id" 
                class="exclusion-text"
                style="cursor: pointer;">
                {{ ex.nom }}
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>
    <!-- Bouton Ajouter -->
    <div style="margin-top: 1rem; display: flex; gap: 1rem; align-items: center;">
      <button 
        pButton 
        type="button" 
        [label]="currentRcExploitation.situations.length > 0 ? 'Ajouter cette RC' : 'Ajouter RC'" 
        (click)="addRcExploitation()"
        [disabled]="currentRcExploitation.situations.length === 0 || !canAddNewRc"
        class="p-button-success"
        style="margin-top: 1rem;">
      </button>
      
      <span *ngIf="!canAddNewRc" style="color: #666; font-size: 0.9em;">
        ‚ùå Toutes les situations sont d√©j√† couvertes par une RC
      </span>
      
      <span *ngIf="currentRcExploitation.situations.length === 0 && canAddNewRc" style="color: #666; font-size: 0.9em;">
        ‚ö†Ô∏è Veuillez s√©lectionner au moins une situation
      </span>
    </div>
 <!-- Navigation -->
        <div class="col-12">
        <div class="flex justify-content-between mt-4">
          <button pButton label="Pr√©c√©dent" icon="pi pi-arrow-left" (click)="currentStep = 4" class="p-button-secondary"></button>
          <button pButton label="Soumettre" icon="pi pi-check" (click)="submit()" class="p-button-success"></button>
        </div>
      </div>
  </div>
</div>
<div class="pdf-sidebar" *ngIf="showModele">
    <div class="pdf-container">
      <div class="pdf-header">
        <h3>Mod√®le de Contrat</h3>
        <button 
          pButton 
          icon="pi pi-times" 
          class="p-button-text p-button-sm"
          (click)="toggleModele()"
          title="Fermer">
        </button>
      </div>
      
      <ng-container *ngIf="pdfUrl; else loading">
        <iframe [src]="pdfUrl" width="100%" height="100%"></iframe>
      </ng-container>
      
      <ng-template #loading>
        <div class="loading-content">
          <p *ngIf="contratData || situationRisques.length > 0" class="loading-text">
            <i class="pi pi-spin pi-spinner" style="margin-right: 8px;"></i>
            G√©n√©ration du PDF en cours...
          </p>
          <p *ngIf="!contratData && situationRisques.length === 0" class="no-data-text">
            <i class="pi pi-info-circle" style="margin-right: 8px;"></i>
            Veuillez d'abord cr√©er au moins une situation de risque pour g√©n√©rer le PDF.
          </p>
        </div>
      </ng-template>
    </div>
  </div>
</div> <!-- Fin de contrat-main-container -->