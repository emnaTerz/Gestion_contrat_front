

<div class="contrat-container">
   <p-toast></p-toast>

  <p-steps [model]="steps" [(activeIndex)]="currentStep"></p-steps>

  <div *ngIf="currentStep === 0">
    <div class="contrat-section">
      <h3>Informations générales</h3>
      <label>Numéro de police:</label>
      <input type="text" [(ngModel)]="numPolice">
      <label>Nom de l'assuré:</label>
      <input type="text" [(ngModel)]="nom_assure">
    </div>

    <div class="contrat-section">
      <h4>Adhérent</h4>
      <label>Code ID:</label>
      <input type="text" [(ngModel)]="adherent.codeId">
      <label>Nom / Raison sociale:</label>
      <input type="text" [(ngModel)]="adherent.nomRaison">
      <label>Adresse:</label>
      <input type="text" [(ngModel)]="adherent.adresse">
      <label>Activité:</label>
      <input type="text" [(ngModel)]="adherent.activite">
    </div>

<div class="contrat-section">
  <label for="fractionnement">Fractionnement:</label>
  <select id="fractionnement" [(ngModel)]="fractionnement">
    <option *ngFor="let opt of fractionnementOptions" [value]="opt.value">{{ opt.label }}</option>
  </select>

  <label for="codeRenouvellement">Code Renouvellement:</label>
  <select id="codeRenouvellement" [(ngModel)]="codeRenouvellement">
    <option *ngFor="let opt of codeRenouvellementOptions" [value]="opt.value">{{ opt.label }}</option>
  </select>

  <label for="branche">Branche:</label>
  <select id="branche" [(ngModel)]="branche">
    <option *ngFor="let opt of brancheOptions" [value]="opt.value">{{ opt.label }}</option>
  </select>

  <label for="typeContrat">Type de contrat:</label>
  <select id="typeContrat" [(ngModel)]="typeContrat">
    <option *ngFor="let opt of typeContratOptions" [value]="opt.value">{{ opt.label }}</option>
  </select>
</div>



    <div class="contrat-section">
      <label>Date de début:</label>
      <input type="date" [(ngModel)]="dateDebut">
      <label>Date de fin:</label>
      <input type="date" [(ngModel)]="dateFin">
    </div>

    <div style="margin-top: 10px; display: flex; gap: 1rem;">
      <button pButton label="Suivant →" (click)="nextStep()"></button>
    </div>
  </div>

  <div *ngIf="currentStep === 1">
    <div class="contrat-section">
      <h3>Situations de risque</h3>

      <label>Identification:</label>
      <input type="text" [(ngModel)]="currentSituationRisque.identification">

      <label>Adresse:</label>
      <input type="text" [(ngModel)]="currentSituationRisque.adresse">

      <label>Nature de construction:</label>
      <input type="text" [(ngModel)]="currentSituationRisque.natureConstruction">

      <label>Contiguïté:</label>
      <input type="text" [(ngModel)]="currentSituationRisque.contiguite">

      <label>Avoisinage:</label>
      <input type="text" [(ngModel)]="currentSituationRisque.avoisinage">

      <div style="margin-top: 10px; display: flex; gap: 1rem;">
        <button pButton label="← Précédent" (click)="prevStep()"></button>
        <button pButton label="Ajouter cette situation" (click)="addSituation()"></button>
        <button pButton label="Suivant →" (click)="nextStep()"></button>
      </div>
    </div>

    <div *ngIf="situationRisques.length > 0" style="margin-top: 2rem;">
      <h4>Situations ajoutées :</h4>
      <ul>
        <li *ngFor="let s of situationRisques; let i = index">
          {{ i + 1 }}. {{ s.identification }} - {{ s.adresse }}
          <i class="pi pi-trash" 
             style="color: #388e3c; cursor: pointer; font-size: 1rem;" 
             (click)="removeSituation(i)" 
             title="Supprimer"></i>
        </li>
      </ul>
    </div>
  </div>

<!-- Étape 3 : Garanties pour toutes les situations -->
<div *ngIf="currentStep === 2">
  <div class="contrat-section">
    <h3>Garanties par situation de risque</h3>

    <div *ngFor="let s of situationRisques; let i = index" class="contrat-section">
      <h4>Situation {{ i + 1 }} : {{ s.identification }}</h4>
      <p>Adresse: {{ s.adresse }}</p>

      <div *ngFor="let g of s.garanties; let j = index" class="garantie-item">
        <input type="hidden" [(ngModel)]="g.sectionId">

        <label for="sousGarantie">Garanties:</label>
        <select id="sousGarantie" [(ngModel)]="g.sousGarantieId" (change)="onGarantieChange(g)">
          <option [value]="0">Sélectionner une garantie</option>
          <option *ngFor="let opt of sousGarantiesOptions" [value]="opt.value">{{ opt.label }}</option>
        </select>

        <!-- Franchise remplacé par input number -->
        <label for="franchise">Franchise:</label>
        <input type="number" id="franchise" [(ngModel)]="g.franchise" placeholder="Saisir la franchise">

        <div class="franchise-fields">
          <label>Limite:</label>
          <input type="number" [(ngModel)]="g.limite">

          <label>Maximum:</label>
          <input type="number" [(ngModel)]="g.maximum">

          <label>Minimum:</label>
          <input type="number" [(ngModel)]="g.minimum">
        </div>

        <label>Capitale:</label>
        <input type="number" [(ngModel)]="g.capitale">

        <label>Prime NET:</label>
        <input type="number" [(ngModel)]="g.primeNET">

        <i class="pi pi-trash" 
           style="color: #388e3c; cursor: pointer; font-size: 1rem; margin-left: 5px;" 
           (click)="removeGarantie(s, j)" 
           title="Supprimer"></i>

        <hr>
      </div>

      <button pButton type="button" label="Ajouter Garantie" (click)="addGarantie(s)"></button>
    </div>
  </div>

  <div style="margin-top: 10px; display: flex; gap: 1rem;">
    <button pButton label="← Précédent" (click)="prevStep()"></button>
    <button pButton label="Suivant →" (click)="nextStep()"></button>
  </div>
</div>
<!-- Étape 4 : Exclusions pour chaque garantie -->
<div *ngIf="currentStep === 3">
  <div class="contrat-section">
    <h3>Exclusions par garantie</h3>

    <div *ngFor="let s of situationRisques; let i = index" class="situation-card">
      <h4 class="situation-title">Situation {{ i + 1 }} : {{ s.identification }}</h4>
      
      <div *ngFor="let g of s.garanties; let j = index" class="garantie-card">
        <div class="garantie-header">
       <h5>{{ getGarantieName(g.sousGarantieId) }}</h5>
          <span class="garantie-badge">Garantie {{ j + 1 }}</span>
        </div>
        
        <div *ngIf="g.exclusionsOptions && g.exclusionsOptions.length > 0" class="exclusions-container">
          <label class="exclusions-label">Sélectionner les exclusions applicables :</label>
            <div class="exclusions-scroll-container">
    <div class="exclusions-list">
      <div *ngFor="let exclusion of g.exclusionsOptions" class="exclusion-item">
        <input 
          type="checkbox" 
          [id]="'exclusion_' + g.sousGarantieId + '_' + exclusion.id"
          [checked]="isExclusionSelected(g, exclusion.id)"
          (change)="toggleExclusion(g, exclusion.id)"
          class="exclusion-checkbox">
        <label 
          [for]="'exclusion_' + g.sousGarantieId + '_' + exclusion.id" 
          class="exclusion-text">
          {{ exclusion.nom }}
        </label>
      </div>
    </div>
  </div>
</div>
        
        <div *ngIf="!g.exclusionsOptions || g.exclusionsOptions.length === 0" class="no-exclusions">
          <p>⚠️ Aucune exclusion disponible pour cette garantie.</p>
        </div>
      </div>
    </div>
  </div>

  <div style="margin-top: 10px; display: flex; gap: 1rem;">
    <button pButton label="← Précédent" (click)="prevStep()"></button>
    <button pButton label="Soumettre" (click)="submit()"></button>
  </div>
</div>