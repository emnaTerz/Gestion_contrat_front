

<div class="contrat-container">
  <p-toast></p-toast>
  <p-steps [model]="steps" [(activeIndex)]="currentStep"></p-steps>


<!-- √âtape 0 : Informations g√©n√©rales -->
<div *ngIf="currentStep === 0">

<div class="contrat-upload-container contrat-section">
  <div class="card">
    <div class="card-title">Importer votre Contrat</div>

    <input 
      type="file" 
      (change)="onPdfSelected($event)" 
      accept=".pdf,.doc,.docx"
      style="padding: 10px; width: 100%; border: 1px solid #ccc; border-radius: 4px;"
    />
    <small>Choisissez un fichier PDF  pour remplir automatiquement les informations g√©n√©rales.</small>
  </div>
</div>


  <!-- Section Adh√©rent -->
  <div class="contrat-section">
    <h3>Informations g√©n√©rales</h3>
    <h4>Adh√©rent</h4>
    <label>Code Adh√©rent:</label>
    <input type="text" [(ngModel)]="adherent.codeId">
    <label>Nom / Raison sociale:</label>
    <input type="text" [(ngModel)]="adherent.nomRaison">
    <label>Adresse:</label>
    <input type="text" [(ngModel)]="adherent.adresse">
    <label>Activit√©:</label>
    <input type="text" [(ngModel)]="adherent.activite">
    <label>
      <input type="checkbox" [(ngModel)]="adherent.nouveau">
      Nouvel adh√©rent ?
    </label>
  </div>

  <!-- Branche -->
  <div class="contrat-section">
    <label for="branche">Branche:</label>
    <select id="branche" [(ngModel)]="branche">
      <option *ngFor="let opt of brancheOptions" [value]="opt.value">{{ opt.label }}</option>
    </select>
  </div>

  <!-- Num√©ro police / assureur / agence -->
  <div class="contrat-section">
    <label>Num√©ro de police:</label>
    <input type="text" [(ngModel)]="numPolice">
    <label>Nom de l'assureur:</label>
    <input type="text" [(ngModel)]="nom_assure">
    <label>Code Agence:</label>
    <input type="text" [(ngModel)]="codeAgence">
  </div>

  <!-- Fractionnement / Code renouvellement / Type contrat -->
  <div class="contrat-section">
    <label for="fractionnement">Fractionnement:</label>
    <select id="fractionnement" [(ngModel)]="fractionnement">
      <option *ngFor="let opt of fractionnementOptions" [value]="opt.value">{{ opt.label }}</option>
    </select>

    <label for="codeRenouvellement">Code Renouvellement:</label>
    <select id="codeRenouvellement" [(ngModel)]="codeRenouvellement">
      <option *ngFor="let opt of codeRenouvellementOptions" [value]="opt.value">{{ opt.label }}</option>
    </select>

    <label for="typeContrat">Type de contrat:</label>
    <select id="typeContrat" [(ngModel)]="typeContrat">
      <option *ngFor="let opt of typeContratOptions" [value]="opt.value">{{ opt.label }}</option>
    </select>
  </div>

  <!-- Dates -->
  <div class="contrat-section">
    <label>Date de d√©but:</label>
    <input type="date" [(ngModel)]="dateDebut">
    <label>Date de fin:</label>
    <input type="date" [(ngModel)]="dateFin">
  </div>

  <!-- Bouton Suivant -->
  <div style="margin-top: 10px; display: flex; gap: 1rem;">
    <button pButton label="Suivant ‚Üí" (click)="nextStep()"></button>
  </div>
</div>

<!-- === Step Pr√©ambule === -->
<div *ngIf="currentStep === 1" class="contrat-section preambule-section">
  <h3>Pr√©ambule du contrat</h3>
  <textarea id="preambuleTextarea"
            class="p-inputtextarea p-component"
            rows="10"
            [(ngModel)]="preambule"
            [attr.maxlength]="preambuleMaxLength"
            style="width:100%; resize:vertical;"></textarea>

  <div class="p-t-2" style="display:flex; justify-content:space-between; align-items:center; margin-top:0.5rem;">
    <div style="margin-top: 10px; display: flex; gap: 1rem;">
    <button pButton label="‚Üê Pr√©c√©dent" (click)="prevStep()"></button>
    <button pButton label="Suivant ‚Üí" (click)="nextStep()"></button>
  </div>
  </div>
</div>


  <!-- √âtape 1 : Situations -->
  <div *ngIf="currentStep === 2">
    <div class="contrat-section">
      <h3>Situations de risque</h3>

      <label>Identification:</label>
      <input type="text" [(ngModel)]="currentSituationRisque.identification">

      <label>Adresse:</label>
      <input type="text" [(ngModel)]="currentSituationRisque.adresse">

      <label>Nature de construction:</label>
      <input type="text" [(ngModel)]="currentSituationRisque.natureConstruction">

      <label>Contigu√Øt√©:</label>
      <input type="text" [(ngModel)]="currentSituationRisque.contiguite">

      <label>Avoisinage:</label>
      <input type="text" [(ngModel)]="currentSituationRisque.avoisinage">

      <div style="margin-top: 10px; display: flex; gap: 1rem;">
        <button pButton label="‚Üê Pr√©c√©dent" (click)="prevStep()"></button>
        <button pButton [label]="editIndex !== null ? 'Valider la modification' : 'Ajouter cette situation'" (click)="addSituation()">
  </button>
        <button pButton label="Suivant ‚Üí" (click)="nextStep()"></button>
      </div>
    </div>

   <div *ngIf="situationRisques.length > 0" style="margin-top: 2rem;">
  <h4>Situations ajout√©es :</h4>
  <ul>
    <li *ngFor="let s of situationRisques; let i = index">
      <span 
        style="cursor: pointer; text-decoration: underline; color: #02bd4a;" 
        (click)="editSituation(i)">
        {{ i + 1 }}. {{ s.identification }} - {{ s.adresse }}
      </span>
      <i class="pi pi-trash" 
         style=" color: #388e3c; cursor: pointer; font-size: 1rem; margin-left: 10px;" 
         (click)="removeSituation(i)" 
         title="Supprimer"></i>
    </li>
  </ul>
</div>
  </div>

<!-- √âtape 2 : Garanties -->
<div *ngIf="currentStep === 3">
  <div class="contrat-section">
    <h3>Garanties par situation de risque</h3>

    <div *ngFor="let s of situationRisques; let i = index" class="contrat-section">
      <h4>Situation {{ i + 1 }} : {{ s.identification }}</h4>
      <p>Adresse: {{ s.adresse }}</p>

      <div *ngFor="let g of s.garanties; let j = index" class="garantie-item">
        <input type="hidden" [(ngModel)]="g.sectionId">

        <label for="sousGarantie">Garanties:</label>
        <select id="sousGarantie" [(ngModel)]="g.sousGarantieId" (change)="onGarantieChange(g)">
          <option [value]="0">S√©lectionner une garantie</option>
          <option *ngFor="let opt of sousGarantiesOptions" [value]="opt.value">{{ opt.label }}</option>
        </select>

        <label>Capitale Assur√©:</label>
        <input type="number" [(ngModel)]="g.capitale">

        <!-- Checkbox Franchise -->
       <div style="margin-bottom: 1rem;">
        <label>
          <input type="checkbox" [(ngModel)]="g.hasFranchise"> Franchise
        </label>
      </div>

    <!-- Champs Franchise affich√©s seulement si checkbox coch√© -->
    <div class="franchise-fields" *ngIf="g.hasFranchise">
      <label>Franchise (%):</label>
      <input type="number" [(ngModel)]="g.franchise" placeholder="Pourcentage">

      <label>Minimum:</label>
      <input type="number" [(ngModel)]="g.minimum" placeholder="Montant minimum">

      <label>Maximum:</label>
      <input type="number" [(ngModel)]="g.maximum" placeholder="Montant maximum">
    </div>

        <label>Prime NET:</label>
        <input type="number" [(ngModel)]="g.primeNET">

        <i class="pi pi-trash" 
           style="color: #388e3c; cursor: pointer; font-size: 1rem; margin-left: 5px;" 
           (click)="removeGarantie(s, j)" 
           title="Supprimer"></i>

        <hr>
      </div>

      <button pButton type="button" label="Ajouter Garantie" (click)="addGarantie(s)"></button>
    </div>
  </div>

  <div style="margin-top: 10px; display: flex; gap: 1rem;">
    <button pButton label="‚Üê Pr√©c√©dent" (click)="prevStep()"></button>
    <button pButton label="Suivant ‚Üí" (click)="nextStep()"></button>
  </div>
</div>

<div *ngIf="currentStep === 4" class="contrat-section">
  <h3>Exclusions par garantie</h3>
  
  <div *ngFor="let s of situationRisques; let i = index">
    <h4>Situation {{ i + 1 }} : {{ s.identification }}</h4>

    <!-- V√©rification si des groupes existent -->
    <div *ngIf="getSousGarantiesParParent(s).length > 0; else noGaranties">
      
      <!-- Parcourir les groupes de sous-garanties par garantie parent -->
      <div *ngFor="let groupe of getSousGarantiesParParent(s); let groupeIndex = index" 
           class="groupe-garantie">
        
        <h5>Garantie : {{ groupe.parent.libelle || 'Garantie sans nom' }}</h5>

     

        <!-- Section pour ajouter une nouvelle exclusion -->
        <div class="ajout-exclusion" 
             *ngIf="groupe.sousGaranties && groupe.sousGaranties.length > 0 && groupe.sousGaranties[0]"
             style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
          
          <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">
            Ajouter une nouvelle exclusion pour cette garantie :
          </label>
          
          <div style="display: flex; gap: 0.5rem;">
            <input 
              type="text" 
              [(ngModel)]="groupe.sousGaranties[0].nouvelleExclusion"
              placeholder="Saisir le nom de la nouvelle exclusion..."
              style="flex: 1; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;"
              (keyup.enter)="ajouterExclusionPersonnalisee(groupe.sousGaranties[0])">
            
            <button 
              pButton 
              label="Ajouter" 
              icon="pi pi-plus"
              (click)="ajouterExclusionPersonnalisee(groupe.sousGaranties[0])"
              class="p-button-sm bouton-ajout-exclusion"
              style="height: 38px; min-width: 100px; display: flex; align-items: center; justify-content: center;"
              [disabled]="!groupe.sousGaranties[0].nouvelleExclusion?.trim()">
            </button>
          </div>
        </div>

        <!-- Liste des exclusions -->
        <div *ngIf="groupe.sousGaranties && groupe.sousGaranties.length > 0 && groupe.sousGaranties[0] && 
                    groupe.sousGaranties[0].exclusionsOptions && groupe.sousGaranties[0].exclusionsOptions.length > 0" 
             class="exclusions-container">
          
          <label class="exclusions-label">S√©lectionner les exclusions applicables :</label>
          
          <div class="exclusions-scroll-container" tabindex="0" 
               (keydown)="handleKeyboardExclusions($event, groupe.sousGaranties[0])">
            
            <div class="exclusions-list">
              <div *ngFor="let exclusion of groupe.sousGaranties[0].filteredExclusionsOptions; let exclIndex = index" 
                   class="exclusion-item">
                
                <input 
                  type="checkbox" 
                  [id]="'exclusion_' + i + '_' + groupeIndex + '_' + exclIndex"
                  [checked]="isExclusionSelected(groupe.sousGaranties[0], exclusion.id)"
                  (change)="toggleExclusion(groupe.sousGaranties[0], exclusion.id)"
                  class="exclusion-checkbox">
                
                <label 
                  [for]="'exclusion_' + i + '_' + groupeIndex + '_' + exclIndex" 
                  class="exclusion-text">
                  {{ exclusion.nom }}
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Message si aucune exclusion disponible -->
        <div *ngIf="!(groupe.sousGaranties && groupe.sousGaranties[0] && groupe.sousGaranties[0].exclusionsOptions) || 
                    (groupe.sousGaranties && groupe.sousGaranties[0] && groupe.sousGaranties[0].exclusionsOptions && 
                     groupe.sousGaranties[0].exclusionsOptions.length === 0)">
          <p>‚ö†Ô∏è Aucune exclusion disponible pour cette garantie.</p>
        </div>

      </div>
    </div>

    <ng-template #noGaranties>
      <p>Aucune garantie disponible pour cette situation.</p>
    </ng-template>
  </div>

  <div style="margin-top: 10px; display: flex; gap: 1rem;">
    <button pButton label="‚Üê Pr√©c√©dent" (click)="prevStep()"></button>
    <button pButton label="Suivant ‚Üí" (click)="nextStep()"></button>
  </div>
</div>
<!-- √âtape 4 : RC Exploitation -->
<div *ngIf="currentStep === 5" class="contrat-section">
  <h3>RC Exploitation</h3>

  <div class="card" style="background-color: #e8f5e9;">
    <label>Objet de la garantie</label>
    <textarea 
      [(ngModel)]="rcExploitation.objetDeLaGarantie" 
      rows="5" 
      class="p-inputtextarea p-component"
      style="width: 100%; resize: vertical;"
    ></textarea>
  </div>

  <!-- Limites et franchise -->
  <label>Limite annuelle Dommages Corporels</label>
  <input type="number" [(ngModel)]="rcExploitation.limiteAnnuelleDomCorporels">

  <label>Limite annuelle Dommages Mat√©riels</label>
  <input type="number" [(ngModel)]="rcExploitation.limiteAnnuelleDomMateriels">

  <label>Limite par sinistre</label>
  <input type="number" [(ngModel)]="rcExploitation.limiteParSinistre">

  <label>Franchise</label>
  <input type="number" [(ngModel)]="rcExploitation.franchise">
   <label>Prime Net</label>
  <input type="number" [(ngModel)]="rcExploitation.primeNET">

  <!-- Situations couvertes -->
  <h4>Situations couvertes :</h4>
  <div *ngFor="let s of situationRisques">
    <label>
      <input type="checkbox" [checked]="isRcSituationSelected(s)" (change)="toggleRcSituation(s, $event)">
      {{ s.identification }}
    </label>
  </div>


  <!-- Section pour ajouter une nouvelle exclusion RC -->


   <div class="ajout-exclusion" style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
  <label style="font-weight: bold; display: block; margin-bottom: 0.5rem;">
     Ajouter une nouvelle exclusion RC :
  </label>
  <div style="display: flex; gap: 0.5rem;">
    <input 
      type="text" 
      [(ngModel)]="nouvelleExclusionRC"
      placeholder="Saisir le nom de la nouvelle exclusion RC..."
      style="flex: 1; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;"
      (keyup.enter)="ajouterExclusionRC()">
<button 
      pButton 
      label="Ajouter" 
      icon="pi pi-plus"
      (click)="ajouterExclusionRC()"
      class="p-button-sm bouton-ajout-exclusion"
      style="height: 38px; min-width: 100px; display: flex; align-items: center; justify-content: center;">
    </button>
  </div>
</div>

    <!-- Exclusions RC scrollable -->
<div *ngIf="filteredExclusionsRC.length > 0" class="exclusions-container">
  <h4 class="exclusions-label">Exclusions RC :</h4>
  <div class="exclusions-scroll-container" tabindex="0"> <!-- üî• tabindex pour focus -->
    <div class="exclusions-list">
      <div *ngFor="let ex of filteredExclusionsRC" class="exclusion-item">
        <input 
          type="checkbox" 
          [id]="'exclusionRC_' + ex.id"
          [checked]="isExclusionRCSelected(ex.id)"
          (change)="toggleExclusionRC(ex.id, $event)"
          class="exclusion-checkbox">
        <label [for]="'exclusionRC_' + ex.id" class="exclusion-text">
          {{ ex.nom }}
        </label>
      </div>
    </div>
  </div>
</div>

     <div style="margin-top: 10px; display: flex; gap: 1rem;">
    <button pButton label="‚Üê Pr√©c√©dent" (click)="prevStep()"></button>
    <button pButton label="Soumettre" (click)="submit()"></button>
  </div>
  </div>

 
</div>
